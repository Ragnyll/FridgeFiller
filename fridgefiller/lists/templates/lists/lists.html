{% extends "base_sidebar.html" %}

{% load item_tags %}

{% block title %}
  Your Shopping Lists
{% endblock %}

{% block style %}
  <style type="text/css">
    #item-count {
        vertical-align: -webkit-baseline-middle;
    }
    #remove-item-form, #add-item-to-pantry-form {
        display: inline;
    }
    #new-item-save {
        float: right;
    }

    #new-item-name {
        width: 43%;
    }
    #new-item-desc {
        width: 43%;
    }
    #new-item-save {
        width: 10%;
    }
    .message {
        width: 100%;
    }
    h4, h6, h2 {
        display: inline;
        vertical-align: middle;
    }
    h4 {
        margin-right: .5em;
    }
    .item-well:hover {
        border: 1px solid #169E83;
    }
    .alert {
        display: flex;
    }
    a.anchor {
        display: block;
        position: relative;
        top: -77px;
        visibility: hidden;
    }
    .popover-content {
        background-color: #34495E;
        color: white;
    }
    .popover.top .arrow:after {
        border-top-color: #34495E;
    }
    #add-item-to-pantry-cost, #edit-item-in-pantry-cost {
        width: 10%;
    }
    #add-item-to-pantry-stock, #edit-item-in-pantry-stock {
        width: 10%;
    }
    #add-item-to-pantry-unit, #edit-item-in-pantry-unit {
        width: 10%;
    }
    .panel-heading {
        padding: 1em;
    }
    .fa .fa-minus, .fa .fa-plus {
        text-size: 32px;
        vertical-align: middle;
    }
  </style>
{% endblock %}

{% block content %}
  <h1 class="text-center">Your Shopping Lists</h1>

  {% if not user_shopping_lists %}
    <div class="text-center">
      <br>
      <h3>
        Looks like you don't have any lists created.
      </h3>
    </div>
  {% else %}
    {% for list in user_shopping_lists %}
      <div class="panel panel-success">
        <div class="panel-heading" id="panel-heading-{{ list.id }}" data-listid="{{ list.id }}" data-toggle="collapse" data-target="l-{{ list.id }}">
          <a class="anchor" id="{{ list.id }}"></a>
          <div class="shopping-list">
            <h2>
              <span id="{{ list.id }}-collapse-indicator" class="fa fa-plus "></span>&nbsp;
              <a>
                {{ list }}&nbsp;&nbsp;&nbsp;
              </a>
            </h2>
            <h4>
              {{ list.description }}
              <div class="pull-right">
                <span id="item-count" class="label label-info">{{ list.items.count }} items</span>
              </div>
            </h4>
          </div>
        </div>
        <div id="l-{{ list.id }}" class="panel-collapse">
          <div class="panel-body collapse" id="panel-body-{{ list.id }}">
            {% if messages %}
              {% for message in messages %}
                <!-- Only show messages that pertain to the list the operation was completed on -->
                {% ifequal message.extra_tags list.id %}
                  <span>{{ message|safe }}</span>
                {% endifequal %}
              {% endfor %}
            {% endif %}

            {% if list.items.all %}
              <div class="row">
                <div class="col-md-3"></div>
                <div class="col-md-4">
                  Item Name
                </div>
                <div class="col-md-5">
                  Item Description
                </div>
              </div>

              {% for item in list.items.all %}
                <div class="item-well well">
                  <div class="row">
                    <div class="col-md-3">
                      <!-- Remove item form -->
                      <form method="POST" id="remove-item-form" action="{% url 'remove-item' %}">
                        {% csrf_token %}
                        <input type="hidden" value="{{ item.name }}" name="remove-item-name">
                        <input type="hidden" value="{{ item.description }}" name="remove-item-description">
                        <input type="hidden" value="{{ list.id }}" name="list-id">
                        <button type="submit" data-toggle="popover" data-placement="top" data-content="Remove this item from your list" class="btn btn-lg btn-danger fa fa-minus-square">&nbsp;from List</button>
                      </form>

                      <!-- Add item to pantry button -->
                      {% if item.name not in user_pantry_item_names %}
                        <form method="POST" id="add-item-to-pantry-form" action="{% url 'add-item-to-pantry' %}">
                          {% csrf_token %}
                          <input type="hidden" name="list_id" value="{{ list.id }}">
                          <input type="hidden" name="add-item-to-pantry-name" value="{{ item.name }}">
                          <input type="hidden" name="add-item-to-pantry-desc" value="{{ item.description }}">

                          <button type="submit" data-itemid="{{ item.id }}" data-listid="{{ list.id }}" data-toggle="popover" data-placement="top" data-content="Add this item to your pantry" class="btn btn-lg  btn-primary fa fa-plus-square add-item-to-pantry-button" id="add-item-to-pantry-button-{{ item.id }}-{{ list.id }}">&nbsp;to Pantry</button>
                        </form>
                        <!-- Scan Barcode button -->
                        <span id="scan-barcode-button-{{ item.id }}-{{ list.id }}" class="btn btn-warning btn-sm fa fa-barcode hidden">&nbsp;Scan Barcode</span>
                      <!-- Edit Pantry amount button -->
                      {% else %}
                        <button data-itemid="{{ item.id }}" data-listid="{{ list.id }}" data-toggle="popover" data-placement="top" data-content="Edit amount of {{ item.name }} in your Pantry" class="btn btn-lg  btn-info fa fa-edit edit-item-in-pantry-button" id="edit-item-in-pantry-button-{{ item.id }}-{{ list.id }}">&nbsp;in Pantry</button>
                      {% endif %}
                    </div>
                    <div class="col-md-4">
                      <h4>{{ item.name }}</h4>
                    </div>
                    <div class="col-md-5">
                      <h6>{{ item.description }}</h6>
                    </div>
                  </div>

                  <!-- Edit in pantry form -->
                  {% if item.name in user_pantry_item_names %}
                    <!-- Get ItemDetail object for item -->
                    {% get_item_detail user_pantry_items item.name as item_detail %}
                    {{ item_detail. }}

                  <div class="hidden" id="edit-item-in-pantry-form-{{item.id}}-{{list.id}}">
                    <br>
                    <form class="form-inline" id="edit-item-in-pantry-form-{{ item.id }}" action="{% url 'edit-item-in-pantry' %}" method="POST">
                      {% csrf_token %}
                      <input type="hidden" class="form-control" name="edit-item-in-pantry-desc" id="edit-item-in-pantry-desc" value="{{ item_detail.description }}">
                      <input type="hidden" class="form-control" name="list_id" value="{{ list.id }}">

                      <input type="text" class="form-control" name="edit-item-in-pantry-name" id="edit-item-in-pantry-name" placeholder="Item Name" value="{{ item_detail.name }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-stock" id="edit-item-in-pantry-stock" placeholder="Amount to add" value="{{ item_detail.get_amount }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-unit" id="edit-item-in-pantry-unit" placeholder="Units (ex: oz)" value="{{ item_detail.unit }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-cost" id="edit-item-in-pantry-cost" placeholder="Item Cost ($)" value="{{ item_detail.get_cost }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-last-purchased" id="datepicker-last-purchased" placeholder="Date Purchased" value="{{ item_detail.get_pretty_last_purchased }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-location-purchased" id="edit-item-in-pantry-location-purchased" placeholder="Location Purchased" value="{{ item_detail.location_purchased }}">
                      <input type="text" class="form-control" name="edit-item-in-pantry-expiration-date" id="datepicker-exp-date" placeholder="Expiration Date" value="{{ item_detail.get_pretty_expiration_date }}">
                      <input type="submit" class="btn btn-sm btn-primary" value="Update Values">
                    </form>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <h3 class="text-center">Looks like this list doesn't contain any items, consider adding some below!</h3>
              <h3 class="text-center" id="delete-list-{{ list.id }}">Done with this list?&nbsp;&nbsp;&nbsp;<button id="delete-list-button-{{ list.id }}" data-listid="{{ list.id }}" class="btn btn-danger delete-list-button">Delete It</button></h3>

              <div class="text-center well hidden" id="delete-list-confirmation-form-{{ list.id }}">
                <h3>Are you sure you want to delete this list?</h3>
                <br>
                <form action="{% url 'delete-list' %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" class="form-control" name="list_id" value="{{ list.id }}">
                  <input type="submit" class="btn btn-success" value="Yes, I am sure, delete it!">
                  <span class="btn btn-danger delete-list-cancel-button" data-listid="{{ list.id }}">No, do not delete the list!</span>
                </form>
              </div>

              <br>
            {% endif %}

            <div class="well">
              <!-- add item form -->
              <form class="form-inline" id="new-item-form" action="{% url 'new-item' %}" method="POST">
                {% csrf_token %}
                <input type="text" class="form-control" name="new-item-name" id="new-item-name" placeholder="Item Name">
                <input type="text" class="form-control" name="new-item-description" id="new-item-desc" placeholder="Item Description" />
                <input type="submit" class="btn btn-primary" value="Add Item" id="new-item-save" />
                <input type="hidden" value="{{list.id}}" name="list-id">
              </form>
              <br>

              <!-- TODO: Add javascript to dynamically add form to add new items to the list -->
              <div class="text-center">
                <span class="btn btn-lg btn-primary text-center">Add Another Item</span>
              </div>
            </div>

            <!-- Only show delete form down here if there are items in the list -->
            {% ifnotequal list.items.count 0 %}
              <h3 class="text-center" id="delete-list-{{ list.id }}">Done with this list?&nbsp;&nbsp;&nbsp;<button id="delete-list-button-{{ list.id }}" data-listid="{{ list.id }}" class="btn btn-danger delete-list-button">Delete It</button></h3>

              <div class="text-center well hidden" id="delete-list-confirmation-form-{{ list.id }}">
                <h3>Are you sure you want to delete this list?</h3>
                <br>
                <form action="{% url 'delete-list' %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" class="form-control" name="list_id" value="{{ list.id }}">
                  <input type="submit" class="btn btn-success" value="Yes, I am sure, delete it!">
                  <span class="btn btn-danger delete-list-cancel-button" data-listid="{{ list.id }}">No, do not delete the list!</span>
                </form>
              </div>
            {% endifnotequal %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <div id="new-list-error">
    {% if messages %}
      {% for message in messages %}
        <!-- Only show messages that pertain to the list the operation was completed on -->
        {% ifequal message.extra_tags -1 %}
          <span>{{ message|safe }}</span>
        {% endifequal %}
      {% endfor %}
    {% endif %}
  </div>

  <div id="new-list">
    <h1 class="text-center">Create a new Shopping List Below</h1>
    <br>
    <form class="form-horizantal" id="new-shoppinglist-form" action="{% url 'new-list' %}" method="POST">
      <div class="row">
        {% csrf_token %}
        <div class="col-md-3">
          <input type="text" class="form-control" name="new-shoppinglist-name" id="new-shoppinglist-name" placeholder="Shopping List Name">
        </div>
        <div class="col-md-6">
          <input type="text" class="form-control" name="new-shoppinglist-desc" id="new-shoppinglist-desc" placeholder="Shopping List Description">
        </div>
        <input type="submit" class="btn btn-primary" value="Save" id="new-item-save" />
      </div>
      <br><br><br>
    </form>
  </div>
  <br>
{% endblock %}

{% block script %}
  <script type="text/javascript">
    $(document).ready(function(){
      $('[data-toggle="popover"]').popover({ trigger: "hover" });

      // if list_id in url, click the panel-header to un-collapse it and change the plus to minus
      if(window.location.hash) {
          var hash = window.location.hash.substring(1)

          // Only try to open panels if the hash is a number
          if(!isNaN(hash)) {
              $('#panel-heading-' + hash).click()
          }
      }
    });

    $('.edit-item-in-pantry-button').click(function(e){
      var item_id = this.dataset.itemid;
      var list_id = this.dataset.listid;

      // hide pantry button
      $('#add-item-to-pantry-button-' + item_id + '-' + list_id).hide();

      // show scan barcode button
      $('#scan-barcode-button-' + item_id + '-' + list_id).removeClass('hidden');

      // init datepicker for last_purchased
      var picker1 = new Pikaday({
        field: $('#edit-item-in-pantry-form-' + item_id + '-' + list_id + ' #datepicker-last-purchased')[0],
        format: 'MM/DD/YYYY',
      });

      // init datepicker for expiration_date
      var picker2 = new Pikaday({
        field: $('#edit-item-in-pantry-form-' + item_id + '-' + list_id + ' #datepicker-exp-date')[0],
        format: 'MM/DD/YYYY',
      });
    });
    $('.edit-item-in-pantry-button').click(function() {
        var list_id = this.dataset.listid;
        var item_id = this.dataset.itemid;

        $('#edit-item-in-pantry-form-' + item_id + '-' + list_id).removeClass('hidden')
    });
    $('.panel-heading').click(function() {
        var list_id = this.dataset.listid;

        // If collapsed, change plus to minus
        if($('#panel-body-' + list_id).hasClass('collapse')) {
            $('#' + list_id + '-collapse-indicator').removeClass('fa-plus')
            $('#' + list_id + '-collapse-indicator').addClass('fa-minus')
        }
        // change minus to plus
        else {
            $('#' + list_id + '-collapse-indicator').removeClass('fa-minus')
            $('#' + list_id + '-collapse-indicator').addClass('fa-plus')
        }

        $('#panel-body-' + list_id).toggleClass('collapse in');
    });

    // Show the user a confirmation form so they don't accidentally delete their lists
    $('.delete-list-button').click(function() {
        var list_id = this.dataset.listid;

        // Hide the initial delete button
        $('#delete-list-' + list_id).addClass('hidden');
        // Show confirmation form
        $('#delete-list-confirmation-form-' + list_id).removeClass('hidden');
    });

    // Hide the confirmation form when the user presses the don't delete button
    $('.delete-list-cancel-button').click(function() {
        var list_id = this.dataset.listid;

        // Hide confirmation form
        $('#delete-list-confirmation-form-' + list_id).addClass('hidden');
        // Show initial delete button
        $('#delete-list-' + list_id).removeClass('hidden');
    });

  </script>
{% endblock %}
